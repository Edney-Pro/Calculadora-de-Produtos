<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Pró-Labore - Encomenda Palotina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --magalu-blue: #007bff;
            --magalu-dark-blue: #0056b3;
            --magalu-light-blue: #e3f2fd;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light-yellow: #fff3cd;
            --orange: #fd7e14;
            --roxo: #6f42c1;
            --laranja: #fd7e14;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .calculator-container {
            width: 100%;
            min-height: 100vh;
            background: white;
            margin: 0;
            border-radius: 0;
        }

        .calculator-header {
            background: linear-gradient(135deg, var(--magalu-blue), var(--magalu-dark-blue));
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
        }

        .section-title {
            color: var(--magalu-blue);
            border-left: 4px solid var(--magalu-blue);
            padding-left: 12px;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        .footer-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            border-top: 2px solid #e9ecef;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .content-area {
            padding-bottom: 180px;
            min-height: calc(100vh - 200px);
        }

        /* BOTÕES PADRONIZADOS */
        .btn-home, .btn-zerar, .btn-avancar, .btn-voltar, .btn-whatsapp {
            height: 50px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
        }

        .btn-home {
            background-color: var(--orange);
            color: white;
        }

        .btn-zerar {
            background-color: var(--warning);
            color: #333;
        }

        .btn-avancar {
            background-color: var(--magalu-blue);
            color: white;
        }

        .btn-voltar {
            background-color: #6c757d;
            color: white;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            width: 100%;
        }

        .form-control:focus {
            border-color: var(--magalu-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .result-section {
            background-color: var(--magalu-light-blue);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .result-block {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--magalu-blue);
        }

        .valor-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success);
            margin: 0.5rem 0;
        }

        .valor-negativo {
            color: var(--danger);
        }

        .lucro-liquido-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: white !important;
            margin: 0.5rem 0;
        }

        .socio-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .socio-card:hover {
            border-color: var(--magalu-blue);
            transform: translateY(-2px);
        }

        .empresa-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid var(--magalu-blue);
        }

        .porcentagem-badge {
            background: var(--magalu-blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .lucro-total {
            background: var(--success);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin: 1rem 0;
        }

        .etapa {
            display: none;
        }

        .etapa.active {
            display: block;
        }

        .progress {
            height: 8px;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            background-color: var(--magalu-blue);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .valor-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
            height: 100%;
        }

        .entrada-card {
            border-left-color: var(--success);
        }

        .investimento-card {
            border-left-color: var(--danger);
        }

        .pendente-card {
            border-left-color: var(--laranja);
        }

        .validation-error {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .etapa2-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            height: 100%;
        }

        .etapa4-content {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .money-input {
            text-align: right;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .content-area {
                padding-bottom: 200px;
            }
            .etapa2-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <!-- Header SIMPLIFICADO -->
        <div class="calculator-header">
            <h1 style="font-size:1.4rem;margin:0;">
                <i class="bi bi-calculator me-2"></i>Calculadora de Pró-Labore
            </h1>
            <p style="margin:0.4rem 0 0 0; font-size:0.9rem; opacity:0.95;">
                Encomenda Palotina — divisão societária
            </p>
        </div>

        <!-- Barra de Progresso -->
        <div class="progress mx-3 mt-3">
            <div class="progress-bar" role="progressbar" style="width: 25%;" id="progressBar"></div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="content-area p-3">
            <!-- ETAPA 1: Dados da Empresa -->
            <div class="etapa active" id="etapa1">
                <!-- Dados da Empresa -->
                <div class="mb-4">
                    <h4 class="section-title"><i class="bi bi-building me-2"></i>Dados da Empresa</h4>
                    <div class="row g-2">
                        <div class="col-12">
                            <input type="text" class="form-control" id="empresa" placeholder="Ex: Minha Empresa LTDA">
                            <div class="text-danger small mt-1 hidden" id="empresaError">Informe o nome da empresa</div>
                        </div>
                    </div>
                </div>

                <!-- Período de Cálculo -->
                <div class="mb-4">
                    <h4 class="section-title"><i class="bi bi-calendar-range me-2"></i>Período de Cálculo</h4>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="dataInicio">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="dataFim">
                        </div>
                    </div>
                </div>

                <!-- Sócios -->
                <div class="mb-4">
                    <h4 class="section-title"><i class="bi bi-people me-2"></i>Sócios</h4>
                    
                    <!-- Sócio 1 -->
                    <div class="socio-card">
                        <div class="row g-2 align-items-center">
                            <div class="col-5">
                                <input type="text" class="form-control" id="socio1" placeholder="Ex: João Silva" value="Sócio 01">
                            </div>
                            <div class="col-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="porcent1" value="15" min="0" max="100" oninput="calcularPorcentagemEmpresa()">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-3">
                                <span class="porcentagem-badge" id="badge1">15%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sócio 2 -->
                    <div class="socio-card">
                        <div class="row g-2 align-items-center">
                            <div class="col-5">
                                <input type="text" class="form-control" id="socio2" placeholder="Ex: Maria Santos" value="Sócio 02">
                            </div>
                            <div class="col-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="porcent2" value="15" min="0" max="100" oninput="calcularPorcentagemEmpresa()">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-3">
                                <span class="porcentagem-badge" id="badge2">15%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Empresa -->
                    <div class="empresa-card">
                        <div class="row g-2 align-items-center">
                            <div class="col-5">
                                <label class="form-label fw-bold">Empresa</label>
                            </div>
                            <div class="col-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="porcentEmpresa" value="70" min="0" max="100" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-3">
                                <span class="porcentagem-badge" id="badgeEmpresa">70%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Total das Porcentagens -->
                    <div class="mt-2 text-center">
                        <small class="text-muted" id="totalPorcentagem">Total: 100%</small>
                        <div class="text-danger small mt-1 hidden" id="porcentagemError">A soma das porcentagens deve ser 100%</div>
                    </div>
                </div>
            </div>

            <!-- ETAPA 2: Valores Financeiros -->
            <div class="etapa" id="etapa2">
                <div class="mb-4 h-100">
                    <h4 class="section-title"><i class="bi bi-cash-coin me-2"></i>Valores Financeiros</h4>
                    
                    <div class="etapa2-grid">
                        <!-- Entradas -->
                        <div class="valor-card entrada-card">
                            <div class="row g-2 align-items-center h-100">
                                <div class="col-2">
                                    <i class="bi bi-arrow-down-circle text-success" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="col-8">
                                    <label class="form-label fw-bold">💰 Valor de Entradas (R$)</label>
                                    <p class="text-muted mb-1" style="font-size: 0.8rem;">Valor já recebido pela empresa</p>
                                </div>
                                <div class="col-12">
                                    <input type="text" class="form-control money-input" id="entradas" placeholder="R$ 0,00" oninput="formatarMoedaInput(this)">
                                </div>
                            </div>
                        </div>

                        <!-- Pendentes -->
                        <div class="valor-card pendente-card">
                            <div class="row g-2 align-items-center h-100">
                                <div class="col-2">
                                    <i class="bi bi-clock text-warning" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="col-8">
                                    <label class="form-label fw-bold">⏳ Valor Pendente (R$)</label>
                                    <p class="text-muted mb-1" style="font-size: 0.8rem;">Valor que ainda vai receber</p>
                                </div>
                                <div class="col-12">
                                    <input type="text" class="form-control money-input" id="pendente" placeholder="R$ 0,00" oninput="formatarMoedaInput(this)">
                                </div>
                            </div>
                        </div>

                        <!-- Investimento -->
                        <div class="valor-card investimento-card">
                            <div class="row g-2 align-items-center h-100">
                                <div class="col-2">
                                    <i class="bi bi-graph-up-arrow text-danger" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="col-8">
                                    <label class="form-label fw-bold">📈 Investimento Realizado (R$)</label>
                                    <p class="text-muted mb-1" style="font-size: 0.8rem;">Mercadoria comprada com valor de retorno</p>
                                </div>
                                <div class="col-12">
                                    <input type="text" class="form-control money-input" id="investimento" placeholder="R$ 0,00" oninput="formatarMoedaInput(this)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-danger small mt-2 hidden" id="valoresError">Informe pelo menos um valor financeiro</div>
                </div>
            </div>

            <!-- ETAPA 3: Resultado Pró-Labore -->
            <div class="etapa" id="etapa3">
                <div class="result-section">
                    <h5 class="text-center mb-3"><i class="bi bi-graph-up me-2"></i>Resultado do Pró-Labore</h5>
                    
                    <!-- Informações Gerais -->
                    <div class="result-block">
                        <h6><i class="bi bi-info-circle me-2"></i>Informações Gerais</h6>
                        <div id="infoGeralContent"></div>
                    </div>

                    <!-- Resumo Financeiro -->
                    <div class="result-block">
                        <h6><i class="bi bi-cash-stack me-2"></i>Resumo Financeiro</h6>
                        <div id="resumoFinanceiroContent"></div>
                    </div>

                    <!-- Lucro Apurado -->
                    <div class="result-block">
                        <h6><i class="bi bi-trophy me-2"></i>Lucro Apurado</h6>
                        <div id="lucroApuradoContent"></div>
                    </div>
                </div>
            </div>

            <!-- ETAPA 4: Resumo Divisão de Lucro -->
            <div class="etapa" id="etapa4">
                <div class="result-section etapa4-content">
                    <h5 class="text-center mb-3"><i class="bi bi-pie-chart me-2"></i>Divisão do Lucro</h5>
                    
                    <!-- Gráfico de Pizza -->
                    <div class="result-block">
                        <h6><i class="bi bi-bar-chart me-2"></i>Distribuição do Lucro</h6>
                        <div class="chart-container">
                            <canvas id="graficoPizza"></canvas>
                        </div>
                    </div>

                    <!-- Divisão Detalhada -->
                    <div class="result-block">
                        <h6><i class="bi bi-list-check me-2"></i>Divisão Detalhada</h6>
                        <div id="divisaoDetalhadaContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rodapé Fixo -->
        <div class="footer-actions">
            <!-- Botões para Etapa 1 -->
            <div class="etapa-buttons etapa1-buttons">
                <div class="row g-2">
                    <div class="col-3">
                        <button class="btn btn-home w-100" onclick="window.location.href='../index.html'">
                            <i class="bi bi-house"></i> Home
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-voltar w-100" onclick="avancarEtapa(1)" disabled>
                            <i class="bi bi-arrow-left"></i> Voltar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-zerar w-100" onclick="zerarCalculadora()">
                            <i class="bi bi-arrow-clockwise"></i> Zerar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-avancar w-100" onclick="avancarEtapa(2)">
                            <i class="bi bi-arrow-right"></i> Avançar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botões para Etapa 2 -->
            <div class="etapa-buttons etapa2-buttons hidden">
                <div class="row g-2">
                    <div class="col-3">
                        <button class="btn btn-home w-100" onclick="window.location.href='../index.html'">
                            <i class="bi bi-house"></i> Home
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-voltar w-100" onclick="avancarEtapa(1)">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-zerar w-100" onclick="zerarCalculadora()">
                            <i class="bi bi-arrow-clockwise"></i> Zerar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-avancar w-100" onclick="avancarEtapa(3)">
                            <i class="bi bi-arrow-right"></i> Avançar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botões para Etapa 3 -->
            <div class="etapa-buttons etapa3-buttons hidden">
                <div class="row g-2">
                    <div class="col-3">
                        <button class="btn btn-home w-100" onclick="window.location.href='../index.html'">
                            <i class="bi bi-house"></i> Home
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-voltar w-100" onclick="avancarEtapa(2)">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-zerar w-100" onclick="zerarCalculadora()">
                            <i class="bi bi-arrow-clockwise"></i> Zerar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-avancar w-100" onclick="avancarEtapa(4)">
                            <i class="bi bi-eye"></i> Ver Resumo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botões para Etapa 4 -->
            <div class="etapa-buttons etapa4-buttons hidden">
                <div class="row g-2">
                    <div class="col-3">
                        <button class="btn btn-home w-100" onclick="window.location.href='../index.html'">
                            <i class="bi bi-house"></i> Home
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-voltar w-100" onclick="avancarEtapa(3)">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-zerar w-100" onclick="zerarCalculadora()">
                            <i class="bi bi-arrow-clockwise"></i> Zerar
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-avancar w-100" disabled>
                            <i class="bi bi-arrow-right"></i> Avançar
                        </button>
                    </div>
                    <div class="col-12 mt-2">
                        <button class="btn btn-whatsapp w-100" id="whatsappBtn" onclick="enviarWhatsApp()">
                            <i class="bi bi-whatsapp"></i> Compartilhar WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let grafico = null;
        let dadosCalculo = {};
        let etapaAtual = 1;

        document.addEventListener('DOMContentLoaded', function() {
            // Configurar datas padrão
            const hoje = new Date();
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            document.getElementById('dataInicio').value = formatarData(primeiroDiaMes);
            document.getElementById('dataFim').value = formatarData(hoje);
            
            // Atualizar badges em tempo real
            document.getElementById('porcent1').addEventListener('input', atualizarPorcentagens);
            document.getElementById('porcent2').addEventListener('input', atualizarPorcentagens);
            
            // Configurar empresa com 70% inicial (15% + 15% = 30% dos sócios)
            document.getElementById('porcentEmpresa').value = 70;
            atualizarPorcentagens();
            updateFooterButtons(1);
        });

        // Função para formatar moeda enquanto digita
        function formatarMoedaInput(input) {
            let value = input.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2) + '';
            value = value.replace(".", ",");
            value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = 'R$ ' + value;
        }

        // Função para converter valor formatado para número
        function converterParaNumero(valorFormatado) {
            if (!valorFormatado || valorFormatado === 'R$ 0,00') return 0;
            let valor = valorFormatado.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
            return parseFloat(valor) || 0;
        }

        function calcularPorcentagemEmpresa() {
            const p1 = parseInt(document.getElementById('porcent1').value) || 0;
            const p2 = parseInt(document.getElementById('porcent2').value) || 0;
            
            // Calcular porcentagem da empresa automaticamente
            const pEmpresa = 100 - p1 - p2;
            
            document.getElementById('porcentEmpresa').value = pEmpresa;
            atualizarPorcentagens();
        }

        function formatarData(data) {
            return data.toISOString().split('T')[0];
        }

        function formatarMoeda(valor) {
            return 'R$ ' + valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function calcularDias(dataInicio, dataFim) {
            const inicio = new Date(dataInicio + 'T00:00:00');
            const fim = new Date(dataFim + 'T00:00:00');
            const diff = fim.getTime() - inicio.getTime();
            return Math.ceil(diff / (1000 * 3600 * 24)) + 1;
        }

        function atualizarPorcentagens() {
            const p1 = parseInt(document.getElementById('porcent1').value) || 0;
            const p2 = parseInt(document.getElementById('porcent2').value) || 0;
            const pEmpresa = parseInt(document.getElementById('porcentEmpresa').value) || 0;
            
            const total = p1 + p2 + pEmpresa;
            
            document.getElementById('badge1').textContent = p1 + '%';
            document.getElementById('badge2').textContent = p2 + '%';
            document.getElementById('badgeEmpresa').textContent = pEmpresa + '%';
            document.getElementById('totalPorcentagem').textContent = `Total: ${total}%`;
            
            // Destacar se o total não for 100%
            const errorElement = document.getElementById('porcentagemError');
            if (total !== 100) {
                document.getElementById('totalPorcentagem').className = 'mt-2 text-center text-danger fw-bold';
                errorElement.classList.remove('hidden');
            } else {
                document.getElementById('totalPorcentagem').className = 'mt-2 text-center text-success fw-bold';
                errorElement.classList.add('hidden');
            }
        }

        function avancarEtapa(novaEtapa) {
            console.log('Tentando avançar para etapa:', novaEtapa);
            
            // Validar etapa atual antes de avançar
            if (novaEtapa === 2 && !validarEtapa1()) {
                console.log('Validação etapa 1 falhou');
                return;
            }
            
            if (novaEtapa === 3 && !validarEtapa2()) {
                console.log('Validação etapa 2 falhou');
                return;
            }
            
            if (novaEtapa === 4) {
                console.log('Calculando para etapa 4');
                calcular();
            }
            
            // Ocultar todas as etapas
            document.querySelectorAll('.etapa').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar etapa selecionada
            const novaEtapaElement = document.getElementById(`etapa${novaEtapa}`);
            if (novaEtapaElement) {
                novaEtapaElement.classList.add('active');
                etapaAtual = novaEtapa;
                console.log('Etapa atual:', etapaAtual);
            }
            
            // Atualizar barra de progresso
            const progresso = (novaEtapa / 4) * 100;
            document.getElementById('progressBar').style.width = `${progresso}%`;
            
            // Atualizar botões do rodapé
            updateFooterButtons(novaEtapa);
            
            // Scroll para o topo
            window.scrollTo(0, 0);
        }

        function updateFooterButtons(etapa) {
            console.log('Atualizando botões para etapa:', etapa);
            
            // Ocultar todos os grupos de botões
            document.querySelectorAll('.etapa-buttons').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Mostrar botões da etapa atual
            const botoesEtapa = document.querySelector(`.etapa${etapa}-buttons`);
            if (botoesEtapa) {
                botoesEtapa.classList.remove('hidden');
                console.log('Botões mostrados para etapa:', etapa);
            }
        }

        function validarEtapa1() {
            const empresa = document.getElementById("empresa").value;
            const p1 = parseInt(document.getElementById("porcent1").value) || 0;
            const p2 = parseInt(document.getElementById("porcent2").value) || 0;
            const pEmpresa = parseInt(document.getElementById("porcentEmpresa").value) || 0;
            
            const empresaError = document.getElementById('empresaError');
            const porcentagemError = document.getElementById('porcentagemError');
            
            let valido = true;
            
            // Validar nome da empresa
            if (!empresa.trim()) {
                document.getElementById('empresa').classList.add('validation-error');
                empresaError.classList.remove('hidden');
                valido = false;
            } else {
                document.getElementById('empresa').classList.remove('validation-error');
                empresaError.classList.add('hidden');
            }
            
            // Validar porcentagens
            if ((p1 + p2 + pEmpresa) !== 100) {
                porcentagemError.classList.remove('hidden');
                valido = false;
            } else {
                porcentagemError.classList.add('hidden');
            }
            
            console.log('Validação etapa 1:', valido);
            return valido;
        }

        function validarEtapa2() {
            const entradas = converterParaNumero(document.getElementById("entradas").value) || 0;
            const pendente = converterParaNumero(document.getElementById("pendente").value) || 0;
            const investimento = converterParaNumero(document.getElementById("investimento").value) || 0;
            
            const valoresError = document.getElementById('valoresError');
            
            // Remover qualquer erro anterior
            valoresError.classList.add('hidden');
            
            if (entradas === 0 && pendente === 0 && investimento === 0) {
                valoresError.classList.remove('hidden');
                console.log('Validação etapa 2 falhou: nenhum valor informado');
                return false;
            }
            
            console.log('Validação etapa 2: OK');
            return true;
        }

        function calcular() {
            console.log('Iniciando cálculo...');
            
            const empresaNome = document.getElementById("empresa").value || "Empresa";
            const socio1 = document.getElementById("socio1").value || "Sócio 01";
            const socio2 = document.getElementById("socio2").value || "Sócio 02";
            const p1 = parseFloat(document.getElementById("porcent1").value) / 100 || 0;
            const p2 = parseFloat(document.getElementById("porcent2").value) / 100 || 0;
            const pEmpresa = parseFloat(document.getElementById("porcentEmpresa").value) / 100 || 0;

            const entradas = converterParaNumero(document.getElementById("entradas").value) || 0;
            const pendente = converterParaNumero(document.getElementById("pendente").value) || 0;
            const investimento = converterParaNumero(document.getElementById("investimento").value) || 0;

            const dataInicio = document.getElementById("dataInicio").value;
            const dataFim = document.getElementById("dataFim").value;

            // Cálculos (SEM CUSTOS)
            const receitaTotal = entradas + pendente;
            const lucroLiquido = receitaTotal - investimento;

            const valEmpresa = lucroLiquido * pEmpresa;
            const valSocio1 = lucroLiquido * p1;
            const valSocio2 = lucroLiquido * p2;

            // Calcular dias
            const dias = calcularDias(dataInicio, dataFim);

            // Salvar dados para uso posterior
            dadosCalculo = {
                empresaNome,
                socio1,
                socio2,
                p1: p1 * 100,
                p2: p2 * 100,
                pEmpresa: pEmpresa * 100,
                entradas,
                pendente,
                investimento,
                receitaTotal,
                lucroLiquido,
                valEmpresa,
                valSocio1,
                valSocio2,
                dataInicio,
                dataFim,
                dias
            };

            console.log('Cálculo concluído:', dadosCalculo);

            // Atualizar interface
            atualizarEtapa3();
            atualizarEtapa4();
        }

        function atualizarEtapa3() {
            console.log('Atualizando etapa 3...');
            
            // Informações Gerais
            document.getElementById('infoGeralContent').innerHTML = `
                <div class="summary-item">
                    <span><i class="bi bi-building"></i> Empresa:</span>
                    <span class="fw-bold">${dadosCalculo.empresaNome}</span>
                </div>
                <div class="summary-item">
                    <span><i class="bi bi-calendar"></i> Período:</span>
                    <span class="fw-bold">${formatarDataBR(dadosCalculo.dataInicio)} a ${formatarDataBR(dadosCalculo.dataFim)}</span>
                </div>
                <div class="summary-item">
                    <span><i class="bi bi-clock"></i> Dias:</span>
                    <span class="fw-bold">${dadosCalculo.dias} dias</span>
                </div>
                <div class="summary-item">
                    <span><i class="bi bi-person"></i> ${dadosCalculo.socio1}:</span>
                    <span class="fw-bold">${dadosCalculo.p1.toFixed(1)}%</span>
                </div>
                <div class="summary-item">
                    <span><i class="bi bi-person"></i> ${dadosCalculo.socio2}:</span>
                    <span class="fw-bold">${dadosCalculo.p2.toFixed(1)}%</span>
                </div>
            `;

            // Resumo Financeiro
            document.getElementById('resumoFinanceiroContent').innerHTML = `
                <div class="summary-item">
                    <span><i class="bi bi-arrow-down-circle text-success"></i> Entradas:</span>
                    <span class="fw-bold text-success">${formatarMoeda(dadosCalculo.entradas)}</span>
                </div>
                <div class="summary-item">
                    <span><i class="bi bi-clock text-warning"></i> Pendentes:</span>
                    <span class="fw-bold" style="color: var(--laranja)">${formatarMoeda(dadosCalculo.pendente)}</span>
                </div>
                <div class="summary-item">
                    <span><i class="bi bi-graph-up-arrow text-danger"></i> Investimento:</span>
                    <span class="fw-bold text-danger">${formatarMoeda(dadosCalculo.investimento)}</span>
                </div>
            `;

            // Lucro Apurado
            const classeLucro = dadosCalculo.lucroLiquido >= 0 ? 'lucro-liquido-display' : 'lucro-liquido-display valor-negativo';
            const textoLucro = dadosCalculo.lucroLiquido >= 0 ? '💰 Lucro Líquido' : '📉 Prejuízo Líquido';
            
            document.getElementById('lucroApuradoContent').innerHTML = `
                <div class="summary-item">
                    <span>Receita Total:</span>
                    <span class="fw-bold">${formatarMoeda(dadosCalculo.receitaTotal)}</span>
                </div>
                <div class="lucro-total">
                    <div>${textoLucro}</div>
                    <div class="${classeLucro}">${formatarMoeda(dadosCalculo.lucroLiquido)}</div>
                </div>
            `;
        }

        function atualizarEtapa4() {
            console.log('Atualizando etapa 4...');
            
            // Atualizar divisão detalhada
            document.getElementById('divisaoDetalhadaContent').innerHTML = `
                <div class="empresa-card mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-building"></i> <strong>Caixa Empresa</strong>
                            <small class="text-muted">(${dadosCalculo.pEmpresa.toFixed(1)}%)</small>
                        </div>
                        <div class="valor-display">${formatarMoeda(dadosCalculo.valEmpresa)}</div>
                    </div>
                </div>
                
                <div class="socio-card mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-person"></i> <strong>Salário ${dadosCalculo.socio1}</strong>
                            <small class="text-muted">(${dadosCalculo.p1.toFixed(1)}%)</small>
                        </div>
                        <div class="valor-display">${formatarMoeda(dadosCalculo.valSocio1)}</div>
                    </div>
                </div>
                
                <div class="socio-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-person"></i> <strong>Salário ${dadosCalculo.socio2}</strong>
                            <small class="text-muted">(${dadosCalculo.p2.toFixed(1)}%)</small>
                        </div>
                        <div class="valor-display">${formatarMoeda(dadosCalculo.valSocio2)}</div>
                    </div>
                </div>
            `;

            // Criar gráfico de pizza
            criarGraficoPizza();
        }

        function criarGraficoPizza() {
            console.log('Criando gráfico de pizza...');
            
            const ctx = document.getElementById('graficoPizza').getContext('2d');
            
            // Destruir gráfico anterior se existir
            if (grafico) {
                grafico.destroy();
            }

            const cores = [
                '#28a745', // Verde - Entradas
                '#fd7e14', // Laranja - Pendente
                '#dc3545', // Vermelho - Investimento
                '#6f42c1', // Roxo - Sócio 1
                '#007bff'  // Azul - Sócio 2
            ];

            grafico = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [
                        'Entradas',
                        'Pendente',
                        'Investimento',
                        `Salário ${dadosCalculo.socio1}`,
                        `Salário ${dadosCalculo.socio2}`
                    ],
                    datasets: [{
                        data: [
                            dadosCalculo.entradas,
                            dadosCalculo.pendente,
                            dadosCalculo.investimento,
                            dadosCalculo.valSocio1,
                            dadosCalculo.valSocio2
                        ],
                        backgroundColor: cores,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function formatarDataBR(dataISO) {
            const data = new Date(dataISO + 'T00:00:00');
            return data.toLocaleDateString('pt-BR');
        }

        function zerarCalculadora() {
            if (confirm('Deseja zerar todos os dados e começar novamente?')) {
                document.getElementById('empresa').value = '';
                document.getElementById('socio1').value = 'Sócio 01';
                document.getElementById('socio2').value = 'Sócio 02';
                document.getElementById('porcent1').value = '15';
                document.getElementById('porcent2').value = '15';
                document.getElementById('porcentEmpresa').value = '70';
                document.getElementById('entradas').value = 'R$ 0,00';
                document.getElementById('pendente').value = 'R$ 0,00';
                document.getElementById('investimento').value = 'R$ 0,00';
                
                // Resetar datas
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                document.getElementById('dataInicio').value = formatarData(primeiroDiaMes);
                document.getElementById('dataFim').value = formatarData(hoje);
                
                // Limpar erros
                document.querySelectorAll('.text-danger').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));
                
                atualizarPorcentagens();
                avancarEtapa(1);
                
                if (grafico) {
                    grafico.destroy();
                    grafico = null;
                }
            }
        }

        function enviarWhatsApp() {
            const message = `*📊 CALCULADORA DE PRÓ-LABORE - ENCOMENDA PALOTINA*\n\n` +
                          `*🏢 Empresa:* ${dadosCalculo.empresaNome}\n` +
                          `*📆 Período:* ${formatarDataBR(dadosCalculo.dataInicio)} a ${formatarDataBR(dadosCalculo.dataFim)} (${dadosCalculo.dias} dias)\n\n` +
                          `*💵 VALORES:*\n` +
                          `Entradas: ${formatarMoeda(dadosCalculo.entradas)}\n` +
                          `Pendentes: ${formatarMoeda(dadosCalculo.pendente)}\n` +
                          `Investimento: ${formatarMoeda(dadosCalculo.investimento)}\n` +
                          `Lucro Líquido: ${formatarMoeda(dadosCalculo.lucroLiquido)}\n\n` +
                          `*👥 DIVISÃO DO LUCRO:*\n` +
                          `Caixa Empresa (${dadosCalculo.pEmpresa.toFixed(1)}%): ${formatarMoeda(dadosCalculo.valEmpresa)}\n` +
                          `Salário ${dadosCalculo.socio1} (${dadosCalculo.p1.toFixed(1)}%): ${formatarMoeda(dadosCalculo.valSocio1)}\n` +
                          `Salário ${dadosCalculo.socio2} (${dadosCalculo.p2.toFixed(1)}%): ${formatarMoeda(dadosCalculo.valSocio2)}\n\n` +
                          `_*Cálculo realizado em ${new Date().toLocaleDateString('pt-BR')}*_`;

            const encoded = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encoded}`, '_blank');
        }
    </script>
</body>
</html>